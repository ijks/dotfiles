#! /usr/bin/zsh

setopt LOCAL_OPTIONS
setopt shwordsplit

source lemonbar_colors
source lemonbar_icons

P="   " # padding
P2=$P$P

_monitors=$(bspc query -M | wc -l)

while read -r line; do
    case $line in
        # Time #
        T*)
            _time="%{A:gsimplecal &:}$ico_clock$P${line:1}%{A}"
            ;;

        # Volume #
        V*)
            _volume="$ico_vol_full ${line:1}"
            ;;
        F*)
            _focus="${line:1}"
            ;;

        # Network #
        Nd)
            _wifi="%{F$red}$ico_wifi%{F-}"
            ;;
        N*)
            case ${line:1} in
                s*)
                    if [[ -n "${line:2}" ]]; then
                        _wifi_signal="${line:2}%"
                        _wifi_color="-"
                    else
                        _wifi_signal=""
                        _wifi_color="$red"
                    fi
                    ;;
                i*)
                    _wifi_ssid="${line:2}"
                    ;;
            esac

            _wifi="%{F$_wifi_color}$ico_wifi$P$_wifi_ssid$P$_wifi_signal%{F-}"
            ;;

        # Battery #
        B*)
            case ${line:1} in
                c)
                    _state="charging"
                    ;;
                d)
                    _state="discharging"
                    ;;
                f)
                    _state="full"
                    ;;
                *)
                    _battery_val=${line:1}
                    _battery_color='-'

                    if [[ $_battery_val -le 10 ]]; then
                        _battery_ico="$ico_bat_0"
                        _battery_color=$red
                    elif [[ $_battery_val -le 40 ]]; then
                        _battery_ico="$ico_bat_1"
                    elif [[ $_battery_val -le 60 ]]; then
                        _battery_ico="$ico_bat_2"
                    elif [[ $_battery_val -le 80 ]]; then
                        _battery_ico="$ico_bat_3"
                    elif [[ $_battery_val -le 100 ]]; then
                        _battery_ico="$ico_bat_4"
                    fi
                    ;;
            esac

            if [[ $_state = "discharging" ]]; then
                _battery="%{F$_battery_color}$_battery_ico$P$_battery_val%%{F-}"
            fi

            if [[ $_state = "charging" ]]; then
                _battery="%{F$green}$ico_bat_c$P$_battery_val%%{F-}"
            fi

            if [[ $_state = "full" ]]; then
                _battery="%{F$green}$_battery_ico$P$_battery_val%%{F-}"
            fi
            ;;

            # bspwm #
            W*)
                _bspwm=""
                IFS=':' # split on ':'
                set -- ${line#?} # set line to $@ or something like that
                while [[ $# -gt 0 ]]; do
                    item=$1
                    name=${item#?}
                    case $item in
                        M*)
                            # active monitor
                            if [[ $_monitors -gt 1 ]] ; then
                                _bspwm="$_bspwm${name}$P"
                            fi 
                            ;;
                        m*)
                            # inactive monitor
                            if [[ $_monitors -gt 1 ]] ; then
                                _bspwm="$_bspwm${name}$P"
                            fi
                            ;;
                        #O*)
                            ## focused occupied desktop
                                #_bspwm="$_bspwm${name}$P"
                            #;;
                        #F*)
                            ## focused free desktop
                                #_bspwm="$_bspwm${name}$P"
                            #;;
                        #U*)
                            ## focused urgent desktop
                                #_bspwm="$_bspwm${name}$P"
                            #;;
                        O*|F*|U*)
                            _bspwm="$_bspwm%{U$blue}%{+u} ${name} %{-u}%{U-}$P"
                            ;;
                        o*)
                            # occupied desktop
                                _bspwm="$_bspwm ${name} $P"
                            ;;
                        f*)
                            # free desktop
                                _bspwm="$_bspwm ${name} $P"
                            ;;
                        u*)
                            # urgent desktop
                                _bspwm="$_bspwm ${name} $P"
                            ;;
                    esac
                    shift
                done
                ;;
    esac

    left="$_bspwm"
    right="$_wifi$P2$_battery$P2$_volume$P2$_time"

    echo "%{l}$P2$left%{c}$center%{r}$right$P2"
done
